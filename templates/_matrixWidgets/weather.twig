{% block templateBody %}
{#
  Ottawa Weather Display - Craft 4 Compatible

  Usage: {% include '_matrixWidgets/weather' %}

  Optional parameters:
  - city: City to display (default: 'Ottawa')
  - lang: Language code (default: auto-detect from site)
#}

{% set city = city ?? 'Ottawa' %}
{% set language = craft.app.language %}
{% set lang = (language starts with 'fr') ? 'fr' : 'en' %}
{% set cacheKey = 'weather_' ~ city|lower ~ '_' ~ lang %}
{% set cacheDuration = 1800 %} {# 30 minutes #}

{# Try to get cached data first #}
{% set weatherData = craft.app.cache.get(cacheKey) %}

{# If no cache, fetch fresh data #}
{% if not weatherData %}
    {% set feedUrl = 'https://api.weather.gc.ca/collections/citypageweather-realtime/items?f=json&limit=1&q=' ~ city|url_encode %}

    {# Fetch data using Craft's HTTP client #}
    {% set client = create('GuzzleHttp\\Client') %}
    {% set response = null %}
    {% set rawData = null %}

    {# Attempt to fetch data - if it fails, response will be null #}
    {% set response = client.get(feedUrl, {
        timeout: 10,
        connect_timeout: 5,
        http_errors: false
    }) %}

    {% if response and response.getStatusCode() == 200 %}
        {% set rawData = response.getBody()|json_decode %}
    {% endif %}

    {% if rawData and rawData.features is defined and rawData.features|length > 0 %}
        {% set properties = rawData.features[0].properties %}
        {% set current = properties.currentConditions ?? null %}
        {% set hourlyForecastGroup = properties.hourlyForecastGroup ?? null %}

        {% set weatherData = {
            current: null,
            periods: []
        } %}

        {# Parse current conditions #}
        {% if current %}
            {% set weatherData = weatherData|merge({
                current: {
                    condition: current.condition[lang] ?? 'N/A',
                    temperature: current.temperature.value[lang] ?? null,
                    feelsLike: current.windChill.value[lang] ?? current.temperature.value[lang] ?? null,
                    humidity: current.relativeHumidity.value[lang] ?? null,
                    windSpeed: current.wind.speed.value[lang] ?? null,
                    windDirection: current.wind.direction.value[lang] ?? null,
                    pressure: current.pressure.value[lang] ?? null,
                    pressureTrend: current.pressure.tendency[lang] ?? null,
                    iconCode: current.iconCode.value ?? null,
                    iconUrl: current.iconCode.url ?? null,
                    lastUpdated: current.timestamp[lang] ?? null,
                }
            }) %}
        {% endif %}

        {# Parse hourly forecasts and group by time of day #}
        {% if hourlyForecastGroup and hourlyForecastGroup.hourlyForecasts is defined %}
            {% set hourlyForecasts = hourlyForecastGroup.hourlyForecasts %}
            {% set periods = {
                morning: { name: 'Morning'|t('weather'), hours: [], range: '6 AM - 12 PM'|t('weather') },
                afternoon: { name: 'Afternoon'|t('weather'), hours: [], range: '12 PM - 6 PM'|t('weather') },
                evening: { name: 'Evening'|t('weather'), hours: [], range: '6 PM - 12 AM'|t('weather') }
            } %}

            {% set now = now %}
            {% set todayDate = now|date('Y-m-d') %}

            {% for forecast in hourlyForecasts %}
                {% set timestamp = forecast.timestamp %}
                {% set forecastDate = timestamp|date('Y-m-d', 'America/Toronto') %}
                {% set hour = timestamp|date('G', 'America/Toronto')|number_format %}

                {# Only process today's forecasts #}
                {% if forecastDate == todayDate %}
                    {% set periodData = {
                        time: timestamp|date('g:i A', 'America/Toronto'),
                        hour: hour,
                        temperature: forecast.temperature.value[lang] ?? null,
                        feelsLike: forecast.windChill.value[lang] ?? forecast.temperature.value[lang] ?? null,
                        condition: forecast.condition[lang] ?? 'N/A',
                        iconCode: forecast.iconCode.value ?? null,
                        iconUrl: forecast.iconCode.url ?? null,
                        windSpeed: forecast.wind.speed.value[lang] ?? null,
                        windDirection: forecast.wind.direction.value[lang] ?? null,
                        precipitation: forecast.lop.value[lang] ?? null,
                    } %}

                    {# Group by time of day #}
                    {% if hour >= 6 and hour < 12 %}
                        {% set periods = periods|merge({
                            morning: periods.morning|merge({
                                hours: periods.morning.hours|merge([periodData])
                            })
                        }) %}
                    {% elseif hour >= 12 and hour < 18 %}
                        {% set periods = periods|merge({
                            afternoon: periods.afternoon|merge({
                                hours: periods.afternoon.hours|merge([periodData])
                            })
                        }) %}
                    {% elseif hour >= 18 and hour < 24 %}
                        {% set periods = periods|merge({
                            evening: periods.evening|merge({
                                hours: periods.evening.hours|merge([periodData])
                            })
                        }) %}
                    {% endif %}
                {% endif %}
            {% endfor %}

            {# Calculate representative data for each period #}
            {% set processedPeriods = [] %}
            {% for key, period in periods %}
                {% if period.hours|length > 0 %}
                    {% set hours = period.hours %}
                    {% set count = hours|length %}
                    {% set middleIndex = (count / 2)|round(0, 'floor') %}
                    {% set representative = hours[middleIndex] %}

                    {# Calculate min/max temperatures #}
                    {% set minTemp = null %}
                    {% set maxTemp = null %}
                    {% for hour in hours %}
                        {% if hour.temperature is not null %}
                            {% set minTemp = minTemp is null ? hour.temperature : min(minTemp, hour.temperature) %}
                            {% set maxTemp = maxTemp is null ? hour.temperature : max(maxTemp, hour.temperature) %}
                        {% endif %}
                    {% endfor %}

                    {# Find most common condition #}
                    {% set conditionCounts = {} %}
                    {% for hour in hours %}
                        {% set condition = hour.condition %}
                        {% set conditionCounts = conditionCounts|merge({
                            (condition): (conditionCounts[condition] ?? 0) + 1
                        }) %}
                    {% endfor %}

                    {# Get the condition with highest count #}
                    {% set mostCommonCondition = representative.condition %}
                    {% set maxCount = 0 %}
                    {% for condition, count in conditionCounts %}
                        {% if count > maxCount %}
                            {% set maxCount = count %}
                            {% set mostCommonCondition = condition %}
                        {% endif %}
                    {% endfor %}

                    {# Calculate average precipitation #}
                    {% set precipSum = 0 %}
                    {% set precipCount = 0 %}
                    {% for hour in hours %}
                        {% if hour.precipitation is not null %}
                            {% set precipSum = precipSum + hour.precipitation %}
                            {% set precipCount = precipCount + 1 %}
                        {% endif %}
                    {% endfor %}
                    {% set avgPrecip = precipCount > 0 ? (precipSum / precipCount)|round : 0 %}

                    {% set processedPeriods = processedPeriods|merge([{
                        name: period.name,
                        range: period.range,
                        temperature: minTemp and maxTemp ? ((minTemp + maxTemp) / 2)|round : representative.temperature,
                        tempRange: minTemp ~ '°C - ' ~ maxTemp ~ '°C',
                        minTemp: minTemp,
                        maxTemp: maxTemp,
                        feelsLike: representative.feelsLike,
                        condition: mostCommonCondition,
                        iconUrl: representative.iconUrl,
                        iconCode: representative.iconCode,
                        windSpeed: representative.windSpeed,
                        windDirection: representative.windDirection,
                        precipitation: avgPrecip,
                    }]) %}
                {% endif %}
            {% endfor %}

            {% set weatherData = weatherData|merge({ periods: processedPeriods }) %}
        {% endif %}

        {# Cache the processed data #}
        {% do craft.app.cache.set(cacheKey, weatherData, cacheDuration) %}
    {% endif %}
{% endif %}

<div class="meteocraft-weather-display" role="region" aria-label="{{ 'Ottawa Weather'|t('weather') }}">
    {% if weatherData %}
        {# Current Conditions #}
        {% if weatherData.current %}
            <div class="meteocraft-current">
                <h2 class="meteocraft-title">{{ 'Current Conditions'|t('weather') }}</h2>

                <div class="meteocraft-current-content">
                    {% if weatherData.current.iconUrl %}
                        <img
                            src="{{ weatherData.current.iconUrl }}"
                            alt="{{ 'Weather icon for'|t('weather') }} {{ weatherData.current.condition }}"
                            class="meteocraft-icon"
                            loading="lazy"
                        >
                    {% endif %}

                    <div class="meteocraft-current-details">
                        <div class="meteocraft-temperature">
                            <span class="meteocraft-temp-value">{{ weatherData.current.temperature }}</span>
                            <span class="meteocraft-temp-unit">°C</span>
                        </div>

                        <div class="meteocraft-condition">{{ weatherData.current.condition }}</div>

                        <dl class="meteocraft-stats">
                            {% if weatherData.current.feelsLike %}
                                <div class="meteocraft-stat">
                                    <dt>{{ 'Feels Like'|t('weather') }}:</dt>
                                    <dd>{{ weatherData.current.feelsLike }}°C</dd>
                                </div>
                            {% endif %}

                            {% if weatherData.current.humidity %}
                                <div class="meteocraft-stat">
                                    <dt>{{ 'Humidity'|t('weather') }}:</dt>
                                    <dd>{{ weatherData.current.humidity }}%</dd>
                                </div>
                            {% endif %}

                            {% if weatherData.current.windSpeed %}
                                <div class="meteocraft-stat">
                                    <dt>{{ 'Wind'|t('weather') }}:</dt>
                                    <dd>{{ weatherData.current.windDirection }} {{ weatherData.current.windSpeed }} km/h</dd>
                                </div>
                            {% endif %}

                            {% if weatherData.current.pressure %}
                                <div class="meteocraft-stat">
                                    <dt>{{ 'Pressure'|t('weather') }}:</dt>
                                    <dd>
                                        {{ weatherData.current.pressure }} kPa
                                        {% if weatherData.current.pressureTrend %}
                                            ({{ weatherData.current.pressureTrend|t('weather') }})
                                        {% endif %}
                                    </dd>
                                </div>
                            {% endif %}
                        </dl>

                        {% if weatherData.current.lastUpdated %}
                            <div class="meteocraft-updated">
                                {{ 'Updated'|t('weather') }}: {{ weatherData.current.lastUpdated|date('g:i A') }}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}

        {# Today's Forecast #}
        {% if weatherData.periods|length %}
            <div class="meteocraft-forecast">
                <h2 class="meteocraft-title">{{ 'Today\'s Forecast'|t('weather') }}</h2>

                <div class="meteocraft-periods">
                    {% for period in weatherData.periods %}
                        <div class="meteocraft-period">
                            <h3 class="meteocraft-period-name">{{ period.name }}</h3>
                            <div class="meteocraft-period-range">{{ period.range }}</div>

                            {% if period.iconUrl %}
                                <img
                                    src="{{ period.iconUrl }}"
                                    alt="{{ 'Weather icon for'|t('weather') }} {{ period.condition }}"
                                    class="meteocraft-icon"
                                    loading="lazy"
                                >
                            {% endif %}

                            <div class="meteocraft-period-temp">
                                {{ period.temperature }}°C
                            </div>

                            <div class="meteocraft-period-condition">{{ period.condition }}</div>

                            {% if period.precipitation > 0 %}
                                <div class="meteocraft-period-precip">
                                    {{ 'Precipitation'|t('weather') }}: {{ period.precipitation }}%
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        {# Attribution #}
        <div class="meteocraft-attribution">
            {{ 'Weather data from'|t('weather') }}
            <a href="https://weather.gc.ca" target="_blank" rel="noopener noreferrer">
                {{ 'Environment and Climate Change Canada'|t('weather') }}
                <span class="sr-only">({{ 'opens in new window'|t('weather') }})</span>
            </a>
        </div>
    {% else %}
        <div class="meteocraft-error" role="alert">
            <p>{{ 'Unable to load weather data'|t('weather') }}</p>
        </div>
    {% endif %}
</div>
{% endblock %}